<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spoiler c'est un Snake</title>
    <style>
        /* General body styling */
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background-color: #ffebcd;
            background-image: url('https://www.transparenttextures.com/patterns/snow.png');
            margin: 0;
            overflow-y: auto;  /* Added for scrolling if needed */
        }

        /* Christmas themed title */
        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #d32f2f;
            font-family: 'Comic Sans MS', cursive;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* User status */
        #userStatus {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.2em;
            color: #a23636;
        }

        /* Instructions section */
        #instructions {
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            text-align: center;
            max-width: 1000px;
            font-size: 1.2em;
            color: #333;
            overflow-y: auto;  /* Added for scrolling if needed */
            max-height: 400px; /* Set a maximum height */

        }

        #gameCanvas {
            background-color: #004d40;
            border: 3px solid #00695c;
            border-radius: 10px;
        }
        

        #start-btn {
            padding: 10px 20px;
            margin: 10px;
            font-size: 1.5em;
            cursor: pointer;
            background-color: #388e3c;
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        #score {
            font-size: 1.8em;
            margin: 15px;
            color: #1565c0;
        }

        #start-btn:hover {
           background-color: #2e7d32;
        }

                .decoration {
    position: relative; /* Change to relative */
    display: flex; /* Use flexbox for centering */
    justify-content: center; /* Horizontally center */
    align-items: center; /* Vertically center */
    height: 100vh; /* Full viewport height to center */
    padding: 20px 0;
}

#santa {
    height: 400px;
    width: auto;
}
        
    </style>
</head>
<body>
      <h1>🐍 Spoiler - C'est un Snake 🐍</h1>
    
    <!-- Game instructions -->
    <div id="instructions">
        <p>Samedi 13h, 2007. Alors que les rayons du soleil filtraient à travers les volets roulants bloqués, Bébé Romain émergea de son sommeil. Il descendit au salon, le cœur léger. Retourner dans le passé avait quelque chose de magique, et il semblait presque oublier l’agitation de Noël et tous les cadeaux qu’il avait à préparer.</p>
<p>Dans la pièce, tous les cinq étaient attablés autour de la table, chacun plongé dans son propre univers. Topapa sirotait son café, préparé avec amour par Dudley à 7h du matin, qui avait eu le temps de refroidir. « Mmm, un délice, » murmura-t-il en frissonnant légèrement à la première gorgée. De l’autre côté, RaseToiLaMoustache croquait à pleines dents dans un pain au chocolat encore chaud, que Grinchemie avait acheté avec soin à la boulangerie à 8h. Malheureusement, lui aussi avait déjà perdu un peu de sa chaleur.</p>
<p>Au centre de la table, la ceinture magique, toujours active, s’affairait à découper des courgettes et des aubergines à l’aide de sa propre ceinture, s’apprêtant à concocter un tian de légumes que Dudley et RaseToiLaMoustache regardaient déjà avec une appréhension grandissante. Dans le salon, téléPapaRition passait l’aspirateur, son bruit sourd se mêlant aux rires et aux bavardages.</p>
<p>Dans la cave, des jumeaux pholques jouaient ensemble au grand déssarroi de Dudley. Depuis le dernier accouchement, les toilettes grouillaient de marmots pholques qui le surprenaient lors de ces commissions entrainant par la même occasion une pluie acide sur la cuvette.</p>
<p>Soudain, dans un éclair de lumière, un magicien fit irruption sur la table, interrompant les conversations avec un geste théâtral. En un instant, Dudley se transforma en pigeon. « Allez j’avais call ! » s’écria-t-il. Il réalisa alors à quel point manger son éclair à la vanille était devenu un véritable casse-tête. La vue de RaseToiLaMoustache et de Bébé Romain, admirant son précieux dessert avec envie, lui rappela une scène similaire de course-poursuite de pigeons à Lyon. Et sans demander son reste, il s’envola avec son éclair.</p>
<p>« Non, il faut que nous restions ensemble pour la prochaine épreuve, » remarqua Topapa, se levant d’un bond. Tous partirent alors à la recherche de Dudley. À peine levés de table, téléPapaRirion prit leurs chaises et les posa sous la table pour y passer l’aspirateur. Les compères grimpèrent les escaliers à toute vitesse, croisant téléPaparition en train de repasser des chaussettes de football.</p>
<p>« Il est sorti par le petit balcon, » leur indiqua-t-il, un sourire amusé sur les lèvres.</p>
<p>Ils sortirent sur le balcon, mais aucune trace de Dudley Flatteur en vue. « Il s’est envolé vers la forêt, » leur annonça téléPaparition, perché sur le toit, occupé à réparer quelques tuiles tout en écoutant à la radio que Leclerc faisait des promos incroyables sur le rayon boucherie.</p>
<p>De retour dans la maison, Topapa et Bébé Romain s’installèrent sur le lit double tandis que Grinchemie prit place sur le petit lit. « MAUAHAH ? » interrogea RaseToiLaMoustache, perplexe. « T’es censé avoir deux ans, retourne dans le landeau, gamin ! » proposa Bébé Romain avec un rire.</p>
<p>Au fond de la boîte de Playmobil, une lumière brillante s’alluma. Grinchemie, curieuse, plongea sa main à l’intérieur, se blessant au passage avec cinq lances et deux épées en plastique qui se trouvèrent là. Lorsqu’elle en sortit une vieille console de jeu bleu clair avec deux ou trois boutons jaunes, un sourire de reconnaissance illumina son visage. « Oh, mais je connais ça, » s’exclama Bébé Romain. « Il y a plein de petits jeux dessus ! »</p>
<p>Cependant, lorsqu’elle tenta de l’allumer, la console exigea la présence de cinq personnes pour fonctionner. Les quatre camarades échangèrent un regard complice. Sans Dudley, cette aventure perdait de sa saveur. Malgré son besoin compulsif de toujours avoir plus de cadeaux, il restait un compagnon fidèle. Qui allait leur apprendre les dernières nouveautés de la cour de récré ? Qui allait accompagner Grinchemie dans la cuisine de PlateUp ? Qui allait aider Topapa à réunir les Titouan de Mario et Donkey ? Qui allait humilier Bébé Romain à Chicken Horse, Towerfall, Boomerang Fu, Switch Sport, … ? Et surtout, c’était RaseToiLaMoustache qui se sentait délaissé sans son éternel adversaire au ping-pong. Il se sentait abandonné car Dudley était son gars sûr tel Gimli pour Legolas. Tous broyaient du noir, pensant que l’aventure serait moins drôle sans Dudley Flatteur. « Que la vie est ennuyante sans notre Dudley préféré quand même. Il me manque un peu, beaucoup quand même. Ce qui est vraiment génial avec lui, c’est qu'il a réussi à s'adapter rapidement à notre niveau, malgré la différence d'âge. Il a un talent inné qui lui permet d'exceller dans tout ce qu'il entreprend. Que ce soit lors de nos jeux, nos conversations ou même nos projets, il sait comment se mettre à notre hauteur.  On va pas se mentir, il est loin d’être un téléteubé. Mais s’il a une grande intelligence naturelle, cela va aussi de pair avec son caractère travailleur et discipliné. Etre capable de comprendre des exercices de maths de prépa c’est une chose, mais avoir la motivation et l’abnégation de le faire, c’est une prouesse d’autant plus grande.» dit Topapa. Et tous acquiescèrent à l’unisson.</p>
<p>Mais perché sur la rambarde de la fenêtre, Dudley Flatteur eut un petit saut de cœur en voyant combien ses compagnons tenaient à lui. Rassuré, il chercha la définition d’agnegation et il entra triomphant dans la chambre, le sourire aux lèvres. « M’aimez-vous maintenant ? » lança-t-il avec un air provocateur.</p>
<p>Et oui, ils venaient de s’en rendre compte, ses gros pieds n’y changeaient rien, ils l’aimaient bien et même beaucoup. Ensemble, ils s’engagèrent à ne plus le lâcher jusqu’à ce qu’il atteigne le lycée, où il serait à son tour le lâcheur.</p>
<p>Le magicien, à ce moment précis, réapparut et le retransforma en humain, parce que, nique la continuité scénaristique. La gameboy de chez Wish s’alluma alors, et un jeu apparut à l’écran. « Oh non, DOSE, je suis revenu pour jouer à Snake ! » se lamenta Dudley.
</p>
<p>Explication du jeu : Il s'agit tout simplement d'un Snake. Faites bouger le serpent pour manger les pommes et grandir. Chaque pomme vaut 5 points. La vitesse augmente en fonction du nombre de pommes mangés. Vous avez le droit à 10 essais pour améliorer votre meilleur score. Impossible sur smartphone.</p>
    </div>
     <img id="santa" class="decoration" src="https://i.imgur.com/DNxEbuK.png" alt="Santa Claus">
    <div id="userStatus"></div>
    <div id="score">Score actuel: 0</div>
    <div id="highest-score">Meilleur score: 0</div>
    <div id="total-play-count">Jeux joués: 0</div>
     <button id="start-btn">Start Game</button>
    <canvas id="gameCanvas" width="400" height="400"></canvas>

    
    <script defer type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC4bjg7lVwd8FU8MREaPhBsBENv5qmiYYM",
            authDomain: "calendrier-de-l-avent-54e3a.firebaseapp.com",
            databaseURL: "https://calendrier-de-l-avent-54e3a-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "calendrier-de-l-avent-54e3a",
            storageBucket: "calendrier-de-l-avent-54e3a.appspot.com",
            messagingSenderId: "850639567855",
            appId: "1:850639567855:web:0d799a1ecca005fcff141a",
            measurementId: "G-PC1W7RYVEH"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = '';
        let playCount = 0;
        let totalPlayCountGame15 = 0;
        let highestScore = 0;

         const startBtn = document.getElementById('start-btn');
        const scoreDisplay = document.getElementById('score');
        const highestScoreDisplay = document.getElementById('highest-score');
        const totalPlayCountDisplay = document.getElementById('total-play-count');

        
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const boxSize = 20;
        const canvasSize = 400;
        const totalBoxes = canvasSize / boxSize;

        let score = 0;
        let snake = [{ x: 9 * boxSize, y: 9 * boxSize }];
        let direction = "RIGHT";
        let food = {
            x: Math.floor(Math.random() * totalBoxes) * boxSize,
            y: Math.floor(Math.random() * totalBoxes) * boxSize
        };

        let initialSpeed = 250;
        let speed = initialSpeed;
        let game;

         onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('userStatus').innerText = `Bienvenue : ${user.email}`;

                const userRef = doc(db, 'users', userId);
                const docSnap = await getDoc(userRef);

                if (!docSnap.exists()) {
                    await setDoc(userRef, { userId: userId, totalPlayCountGame15: 0, highestScoreGame15: 0, UserEmail: user.email });
                } else {
                    const userData = docSnap.data();
                    totalPlayCountGame15 = userData.totalPlayCountGame15 || 0;
                    highestScore = userData.highestScoreGame15 || 0;
                    playCount = totalPlayCountGame15 + 1;
                    UserEmail: user.email
                    
                    highestScoreDisplay.innerText = `Meilleur score: ${highestScore}`;
                    totalPlayCountDisplay.innerText = `Jeux joués: ${totalPlayCountGame15}`;
                    
                    
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        document.addEventListener("keydown", changeDirection);
        startBtn.addEventListener('click', startGame);

        function startGame() {
            score = 0;
            speed = initialSpeed;
            playCount = totalPlayCountGame15 + 1;
            snake = [{ x: 9 * boxSize, y: 9 * boxSize }];
            direction = "RIGHT";
            document.getElementById("score").innerText = score;

            clearInterval(game);
            game = setInterval(drawGame, speed);
        }

        function changeDirection(event) {
                // Prevent default scroll behavior if the arrow keys are used
            if (["ArrowLeft", "ArrowUp", "ArrowRight", "ArrowDown"].includes(event.key)) {
                event.preventDefault();
    }
            if (event.key === "ArrowLeft" && direction !== "RIGHT") direction = "LEFT";
            if (event.key === "ArrowUp" && direction !== "DOWN") direction = "UP";
            if (event.key === "ArrowRight" && direction !== "LEFT") direction = "RIGHT";
            if (event.key === "ArrowDown" && direction !== "UP") direction = "DOWN";
        }

        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Dessine le serpent avec des segments arrondis et une tête plus marquée
            for (let i = 0; i < snake.length; i++) {
                ctx.fillStyle = i === 0 ? "#ffeb3b" : "#81c784"; // Tête en jaune, corps en vert
                ctx.beginPath();
                ctx.roundRect(snake[i].x, snake[i].y, boxSize, boxSize, i === 0 ? 6 : 3); // Tête arrondie
                ctx.fill();
                if (i === 0) {
                    // Dessine les yeux pour la tête
                    ctx.fillStyle = "#004d40";
                    const eyeOffset = 4;
                    ctx.beginPath();
                    ctx.arc(snake[i].x + eyeOffset, snake[i].y + eyeOffset, 2, 0, Math.PI * 2);
                    ctx.arc(snake[i].x + boxSize - eyeOffset, snake[i].y + eyeOffset, 2, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            // Dessine la nourriture sous forme de pomme avec une couleur rouge et un reflet
            ctx.fillStyle = "#e57373";
            ctx.beginPath();
            ctx.arc(food.x + boxSize / 2, food.y + boxSize / 2, boxSize / 2, 0, Math.PI * 2);
            ctx.fill();

            // Reflet pour la nourriture
            ctx.fillStyle = "rgba(255, 255, 255, 0.3)";
            ctx.beginPath();
            ctx.arc(food.x + boxSize / 2 - 4, food.y + boxSize / 2 - 4, boxSize / 4, 0, Math.PI * 2);
            ctx.fill();

            // Déplacement du serpent
            let snakeX = snake[0].x;
            let snakeY = snake[0].y;
            if (direction === "LEFT") snakeX -= boxSize;
            if (direction === "UP") snakeY -= boxSize;
            if (direction === "RIGHT") snakeX += boxSize;
            if (direction === "DOWN") snakeY += boxSize;

            if (snakeX === food.x && snakeY === food.y) {
               score += 5;
              scoreDisplay.textContent = "Score actuel: " + score;

                clearInterval(game);
                speed = initialSpeed - (score * (200 / 75));
                speed = Math.max(60, speed);
                game = setInterval(drawGame, speed);

                food = {
                    x: Math.floor(Math.random() * totalBoxes) * boxSize,
                    y: Math.floor(Math.random() * totalBoxes) * boxSize
                };
            } else {
                snake.pop();
            }

            const newHead = { x: snakeX, y: snakeY };

            if (snakeX < 0 || snakeY < 0 || snakeX >= canvas.width || snakeY >= canvas.height || collision(newHead, snake)) {
                clearInterval(game);
                saveScore();
                alert("Game Over! Score final: " + score);
                
            }

            snake.unshift(newHead);
        }

        function collision(head, array) {
            for (let i = 0; i < array.length; i++) {
                if (head.x === array[i].x && head.y === array[i].y) {
                    return true;
                }
            }
            return false;
        }

        // Ajout de roundRect si non supporté par le navigateur
        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
                r = Math.min(r, w / 2, h / 2);
                this.beginPath();
                this.moveTo(x + r, y);
                this.arcTo(x + w, y, x + w, y + h, r);
                this.arcTo(x + w, y + h, x, y + h, r);
                this.arcTo(x, y + h, x, y, r);
                this.arcTo(x, y, x + w, y, r);
                this.closePath();
                return this;
            };
        }

                async function saveScore() {
            try {
                const gameData = { score: score, playCount: playCount, timestamp: new Date() };
                await addDoc(collection(db, 'users', userId, 'Game15'), gameData);
                totalPlayCountGame15 += 1;
                await updateDoc(doc(db, 'users', userId), { totalPlayCountGame15: totalPlayCountGame15 });
                totalPlayCountDisplay.innerText = `Jeux joués: ${totalPlayCountGame15}`;  // Update display for total play count
                console.log("Saving score:", score);
                
                const userRef = doc(db, 'users', userId);
                if (totalPlayCountGame15 <= 10 && score > highestScore) {
                    highestScore = score;
                    await updateDoc(userRef, { highestScoreGame15: highestScore });
                    highestScoreDisplay.innerText = `Meilleur score: ${highestScore}`; // Update display for highest score
                }
            } catch (error) {
                console.error("Error saving score:", error);
            }
        }
        
    </script>

</body>
</html>
