<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spoiler c'est un Snake</title>
    <style>
        /* General body styling */
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background-color: #ffebcd;
            background-image: url('https://www.transparenttextures.com/patterns/snow.png');
            margin: 0;
            overflow-y: auto;  /* Added for scrolling if needed */
        }

        /* Christmas themed title */
        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #d32f2f;
            font-family: 'Comic Sans MS', cursive;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* User status */
        #userStatus {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.2em;
            color: #a23636;
        }

        /* Instructions section */
        #instructions {
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            text-align: center;
            max-width: 1000px;
            font-size: 1.2em;
            color: #333;
            overflow-y: auto;  /* Added for scrolling if needed */
            max-height: 400px; /* Set a maximum height */

        }

        #gameCanvas {
            background-color: #004d40;
            border: 3px solid #00695c;
            border-radius: 10px;
        }
        

        #start-btn {
            padding: 10px 20px;
            margin: 10px;
            font-size: 1.5em;
            cursor: pointer;
            background-color: #388e3c;
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        #score {
            font-size: 1.8em;
            margin: 15px;
            color: #1565c0;
        }

        #start-btn:hover {
           background-color: #2e7d32;
        }

                .decoration {
    position: relative; /* Change to relative */
    display: flex; /* Use flexbox for centering */
    justify-content: center; /* Horizontally center */
    align-items: center; /* Vertically center */
    height: 100vh; /* Full viewport height to center */
    padding: 20px 0;
}

#santa {
    height: 400px;
    width: auto;
}
        
    </style>
</head>
<body>
      <h1>ğŸ Spoiler - C'est un Snake ğŸ</h1>
    
    <!-- Game instructions -->
    <div id="instructions">
        <p>Samedi 13h, 2007. Alors que les rayons du soleil filtraient Ã  travers les volets roulants bloquÃ©s, BÃ©bÃ© Romain Ã©mergea de son sommeil. Il descendit au salon, le cÅ“ur lÃ©ger. Retourner dans le passÃ© avait quelque chose de magique, et il semblait presque oublier lâ€™agitation de NoÃ«l et tous les cadeaux quâ€™il avait Ã  prÃ©parer.</p>
<p>Dans la piÃ¨ce, tous les cinq Ã©taient attablÃ©s autour de la table, chacun plongÃ© dans son propre univers. Topapa sirotait son cafÃ©, prÃ©parÃ© avec amour par Dudley Ã  7h du matin, qui avait eu le temps de refroidir. Â« Mmm, un dÃ©lice, Â» murmura-t-il en frissonnant lÃ©gÃ¨rement Ã  la premiÃ¨re gorgÃ©e. De lâ€™autre cÃ´tÃ©, RaseToiLaMoustache croquait Ã  pleines dents dans un pain au chocolat encore chaud, que Grinchemie avait achetÃ© avec soin Ã  la boulangerie Ã  8h. Malheureusement, lui aussi avait dÃ©jÃ  perdu un peu de sa chaleur.</p>
<p>Au centre de la table, la ceinture magique, toujours active, sâ€™affairait Ã  dÃ©couper des courgettes et des aubergines Ã  lâ€™aide de sa propre ceinture, sâ€™apprÃªtant Ã  concocter un tian de lÃ©gumes que Dudley et RaseToiLaMoustache regardaient dÃ©jÃ  avec une apprÃ©hension grandissante. Dans le salon, tÃ©lÃ©PapaRition passait lâ€™aspirateur, son bruit sourd se mÃªlant aux rires et aux bavardages.</p>
<p>Dans la cave, des jumeaux pholques jouaient ensemble au grand dÃ©ssarroi de Dudley. Depuis le dernier accouchement, les toilettes grouillaient de marmots pholques qui le surprenaient lors de ces commissions entrainant par la mÃªme occasion une pluie acide sur la cuvette.</p>
<p>Soudain, dans un Ã©clair de lumiÃ¨re, un magicien fit irruption sur la table, interrompant les conversations avec un geste thÃ©Ã¢tral. En un instant, Dudley se transforma en pigeon. Â« Allez jâ€™avais call ! Â» sâ€™Ã©cria-t-il. Il rÃ©alisa alors Ã  quel point manger son Ã©clair Ã  la vanille Ã©tait devenu un vÃ©ritable casse-tÃªte. La vue de RaseToiLaMoustache et de BÃ©bÃ© Romain, admirant son prÃ©cieux dessert avec envie, lui rappela une scÃ¨ne similaire de course-poursuite de pigeons Ã  Lyon. Et sans demander son reste, il sâ€™envola avec son Ã©clair.</p>
<p>Â« Non, il faut que nous restions ensemble pour la prochaine Ã©preuve, Â» remarqua Topapa, se levant dâ€™un bond. Tous partirent alors Ã  la recherche de Dudley. Ã€ peine levÃ©s de table, tÃ©lÃ©PapaRirion prit leurs chaises et les posa sous la table pour y passer lâ€™aspirateur. Les compÃ¨res grimpÃ¨rent les escaliers Ã  toute vitesse, croisant tÃ©lÃ©Paparition en train de repasser des chaussettes de football.</p>
<p>Â« Il est sorti par le petit balcon, Â» leur indiqua-t-il, un sourire amusÃ© sur les lÃ¨vres.</p>
<p>Ils sortirent sur le balcon, mais aucune trace de Dudley Flatteur en vue. Â« Il sâ€™est envolÃ© vers la forÃªt, Â» leur annonÃ§a tÃ©lÃ©Paparition, perchÃ© sur le toit, occupÃ© Ã  rÃ©parer quelques tuiles tout en Ã©coutant Ã  la radio que Leclerc faisait des promos incroyables sur le rayon boucherie.</p>
<p>De retour dans la maison, Topapa et BÃ©bÃ© Romain sâ€™installÃ¨rent sur le lit double tandis que Grinchemie prit place sur le petit lit. Â« MAUAHAH ? Â» interrogea RaseToiLaMoustache, perplexe. Â« Tâ€™es censÃ© avoir deux ans, retourne dans le landeau, gamin ! Â» proposa BÃ©bÃ© Romain avec un rire.</p>
<p>Au fond de la boÃ®te de Playmobil, une lumiÃ¨re brillante sâ€™alluma. Grinchemie, curieuse, plongea sa main Ã  lâ€™intÃ©rieur, se blessant au passage avec cinq lances et deux Ã©pÃ©es en plastique qui se trouvÃ¨rent lÃ . Lorsquâ€™elle en sortit une vieille console de jeu bleu clair avec deux ou trois boutons jaunes, un sourire de reconnaissance illumina son visage. Â« Oh, mais je connais Ã§a, Â» sâ€™exclama BÃ©bÃ© Romain. Â« Il y a plein de petits jeux dessus ! Â»</p>
<p>Cependant, lorsquâ€™elle tenta de lâ€™allumer, la console exigea la prÃ©sence de cinq personnes pour fonctionner. Les quatre camarades Ã©changÃ¨rent un regard complice. Sans Dudley, cette aventure perdait de sa saveur. MalgrÃ© son besoin compulsif de toujours avoir plus de cadeaux, il restait un compagnon fidÃ¨le. Qui allait leur apprendre les derniÃ¨res nouveautÃ©s de la cour de rÃ©crÃ© ? Qui allait accompagner Grinchemie dans la cuisine de PlateUp ? Qui allait aider Topapa Ã  rÃ©unir les Titouan de Mario et Donkey ? Qui allait humilier BÃ©bÃ© Romain Ã  Chicken Horse, Towerfall, Boomerang Fu, Switch Sport, â€¦ ? Et surtout, câ€™Ã©tait RaseToiLaMoustache qui se sentait dÃ©laissÃ© sans son Ã©ternel adversaire au ping-pong. Il se sentait abandonnÃ© car Dudley Ã©tait son gars sÃ»r tel Gimli pour Legolas. Tous broyaient du noir, pensant que lâ€™aventure serait moins drÃ´le sans Dudley Flatteur. Â« Que la vie est ennuyante sans notre Dudley prÃ©fÃ©rÃ© quand mÃªme. Il me manque un peu, beaucoup quand mÃªme. Ce qui est vraiment gÃ©nial avec lui, câ€™est qu'il a rÃ©ussi Ã  s'adapter rapidement Ã  notre niveau, malgrÃ© la diffÃ©rence d'Ã¢ge. Il a un talent innÃ© qui lui permet d'exceller dans tout ce qu'il entreprend. Que ce soit lors de nos jeux, nos conversations ou mÃªme nos projets, il sait comment se mettre Ã  notre hauteur.  On va pas se mentir, il est loin dâ€™Ãªtre un tÃ©lÃ©teubÃ©. Mais sâ€™il a une grande intelligence naturelle, cela va aussi de pair avec son caractÃ¨re travailleur et disciplinÃ©. Etre capable de comprendre des exercices de maths de prÃ©pa câ€™est une chose, mais avoir la motivation et lâ€™abnÃ©gation de le faire, câ€™est une prouesse dâ€™autant plus grande.Â» dit Topapa. Et tous acquiescÃ¨rent Ã  lâ€™unisson.</p>
<p>Mais perchÃ© sur la rambarde de la fenÃªtre, Dudley Flatteur eut un petit saut de cÅ“ur en voyant combien ses compagnons tenaient Ã  lui. RassurÃ©, il chercha la dÃ©finition dâ€™agnegation et il entra triomphant dans la chambre, le sourire aux lÃ¨vres. Â« Mâ€™aimez-vous maintenant ? Â» lanÃ§a-t-il avec un air provocateur.</p>
<p>Et oui, ils venaient de sâ€™en rendre compte, ses gros pieds nâ€™y changeaient rien, ils lâ€™aimaient bien et mÃªme beaucoup. Ensemble, ils sâ€™engagÃ¨rent Ã  ne plus le lÃ¢cher jusquâ€™Ã  ce quâ€™il atteigne le lycÃ©e, oÃ¹ il serait Ã  son tour le lÃ¢cheur.</p>
<p>Le magicien, Ã  ce moment prÃ©cis, rÃ©apparut et le retransforma en humain, parce que, nique la continuitÃ© scÃ©naristique. La gameboy de chez Wish sâ€™alluma alors, et un jeu apparut Ã  lâ€™Ã©cran. Â« Oh non, DOSE, je suis revenu pour jouer Ã  Snake ! Â» se lamenta Dudley.
</p>
<p>Explication du jeu : Il s'agit tout simplement d'un Snake. Faites bouger le serpent pour manger les pommes et grandir. Chaque pomme vaut 5 points. La vitesse augmente en fonction du nombre de pommes mangÃ©s. Vous avez le droit Ã  10 essais pour amÃ©liorer votre meilleur score. Impossible sur smartphone.</p>
    </div>
     <img id="santa" class="decoration" src="https://i.imgur.com/DNxEbuK.png" alt="Santa Claus">
    <div id="userStatus"></div>
    <div id="score">Score actuel: 0</div>
    <div id="highest-score">Meilleur score: 0</div>
    <div id="total-play-count">Jeux jouÃ©s: 0</div>
     <button id="start-btn">Start Game</button>
    <canvas id="gameCanvas" width="400" height="400"></canvas>

    
    <script defer type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC4bjg7lVwd8FU8MREaPhBsBENv5qmiYYM",
            authDomain: "calendrier-de-l-avent-54e3a.firebaseapp.com",
            databaseURL: "https://calendrier-de-l-avent-54e3a-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "calendrier-de-l-avent-54e3a",
            storageBucket: "calendrier-de-l-avent-54e3a.appspot.com",
            messagingSenderId: "850639567855",
            appId: "1:850639567855:web:0d799a1ecca005fcff141a",
            measurementId: "G-PC1W7RYVEH"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = '';
        let playCount = 0;
        let totalPlayCountGame15 = 0;
        let highestScore = 0;

         const startBtn = document.getElementById('start-btn');
        const scoreDisplay = document.getElementById('score');
        const highestScoreDisplay = document.getElementById('highest-score');
        const totalPlayCountDisplay = document.getElementById('total-play-count');

        
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const boxSize = 20;
        const canvasSize = 400;
        const totalBoxes = canvasSize / boxSize;

        let score = 0;
        let snake = [{ x: 9 * boxSize, y: 9 * boxSize }];
        let direction = "RIGHT";
        let food = {
            x: Math.floor(Math.random() * totalBoxes) * boxSize,
            y: Math.floor(Math.random() * totalBoxes) * boxSize
        };

        let initialSpeed = 250;
        let speed = initialSpeed;
        let game;

         onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('userStatus').innerText = `Bienvenue : ${user.email}`;

                const userRef = doc(db, 'users', userId);
                const docSnap = await getDoc(userRef);

                if (!docSnap.exists()) {
                    await setDoc(userRef, { userId: userId, totalPlayCountGame15: 0, highestScoreGame15: 0, UserEmail: user.email });
                } else {
                    const userData = docSnap.data();
                    totalPlayCountGame15 = userData.totalPlayCountGame15 || 0;
                    highestScore = userData.highestScoreGame15 || 0;
                    playCount = totalPlayCountGame15 + 1;
                    UserEmail: user.email
                    
                    highestScoreDisplay.innerText = `Meilleur score: ${highestScore}`;
                    totalPlayCountDisplay.innerText = `Jeux jouÃ©s: ${totalPlayCountGame15}`;
                    
                    
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        document.addEventListener("keydown", changeDirection);
        startBtn.addEventListener('click', startGame);

        function startGame() {
            score = 0;
            speed = initialSpeed;
            playCount = totalPlayCountGame15 + 1;
            snake = [{ x: 9 * boxSize, y: 9 * boxSize }];
            direction = "RIGHT";
            document.getElementById("score").innerText = score;

            clearInterval(game);
            game = setInterval(drawGame, speed);
        }

        function changeDirection(event) {
                // Prevent default scroll behavior if the arrow keys are used
            if (["ArrowLeft", "ArrowUp", "ArrowRight", "ArrowDown"].includes(event.key)) {
                event.preventDefault();
    }
            if (event.key === "ArrowLeft" && direction !== "RIGHT") direction = "LEFT";
            if (event.key === "ArrowUp" && direction !== "DOWN") direction = "UP";
            if (event.key === "ArrowRight" && direction !== "LEFT") direction = "RIGHT";
            if (event.key === "ArrowDown" && direction !== "UP") direction = "DOWN";
        }

        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Dessine le serpent avec des segments arrondis et une tÃªte plus marquÃ©e
            for (let i = 0; i < snake.length; i++) {
                ctx.fillStyle = i === 0 ? "#ffeb3b" : "#81c784"; // TÃªte en jaune, corps en vert
                ctx.beginPath();
                ctx.roundRect(snake[i].x, snake[i].y, boxSize, boxSize, i === 0 ? 6 : 3); // TÃªte arrondie
                ctx.fill();
                if (i === 0) {
                    // Dessine les yeux pour la tÃªte
                    ctx.fillStyle = "#004d40";
                    const eyeOffset = 4;
                    ctx.beginPath();
                    ctx.arc(snake[i].x + eyeOffset, snake[i].y + eyeOffset, 2, 0, Math.PI * 2);
                    ctx.arc(snake[i].x + boxSize - eyeOffset, snake[i].y + eyeOffset, 2, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            // Dessine la nourriture sous forme de pomme avec une couleur rouge et un reflet
            ctx.fillStyle = "#e57373";
            ctx.beginPath();
            ctx.arc(food.x + boxSize / 2, food.y + boxSize / 2, boxSize / 2, 0, Math.PI * 2);
            ctx.fill();

            // Reflet pour la nourriture
            ctx.fillStyle = "rgba(255, 255, 255, 0.3)";
            ctx.beginPath();
            ctx.arc(food.x + boxSize / 2 - 4, food.y + boxSize / 2 - 4, boxSize / 4, 0, Math.PI * 2);
            ctx.fill();

            // DÃ©placement du serpent
            let snakeX = snake[0].x;
            let snakeY = snake[0].y;
            if (direction === "LEFT") snakeX -= boxSize;
            if (direction === "UP") snakeY -= boxSize;
            if (direction === "RIGHT") snakeX += boxSize;
            if (direction === "DOWN") snakeY += boxSize;

            if (snakeX === food.x && snakeY === food.y) {
               score += 5;
              scoreDisplay.textContent = "Score actuel: " + score;

                clearInterval(game);
                speed = initialSpeed - (score * (200 / 75));
                speed = Math.max(60, speed);
                game = setInterval(drawGame, speed);

                food = {
                    x: Math.floor(Math.random() * totalBoxes) * boxSize,
                    y: Math.floor(Math.random() * totalBoxes) * boxSize
                };
            } else {
                snake.pop();
            }

            const newHead = { x: snakeX, y: snakeY };

            if (snakeX < 0 || snakeY < 0 || snakeX >= canvas.width || snakeY >= canvas.height || collision(newHead, snake)) {
                clearInterval(game);
                saveScore();
                alert("Game Over! Score final: " + score);
                
            }

            snake.unshift(newHead);
        }

        function collision(head, array) {
            for (let i = 0; i < array.length; i++) {
                if (head.x === array[i].x && head.y === array[i].y) {
                    return true;
                }
            }
            return false;
        }

        // Ajout de roundRect si non supportÃ© par le navigateur
        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
                r = Math.min(r, w / 2, h / 2);
                this.beginPath();
                this.moveTo(x + r, y);
                this.arcTo(x + w, y, x + w, y + h, r);
                this.arcTo(x + w, y + h, x, y + h, r);
                this.arcTo(x, y + h, x, y, r);
                this.arcTo(x, y, x + w, y, r);
                this.closePath();
                return this;
            };
        }

                async function saveScore() {
            try {
                const gameData = { score: score, playCount: playCount, timestamp: new Date() };
                await addDoc(collection(db, 'users', userId, 'Game15'), gameData);
                totalPlayCountGame15 += 1;
                await updateDoc(doc(db, 'users', userId), { totalPlayCountGame15: totalPlayCountGame15 });
                totalPlayCountDisplay.innerText = `Jeux jouÃ©s: ${totalPlayCountGame15}`;  // Update display for total play count
                console.log("Saving score:", score);
                
                const userRef = doc(db, 'users', userId);
                if (totalPlayCountGame15 <= 10 && score > highestScore) {
                    highestScore = score;
                    await updateDoc(userRef, { highestScoreGame15: highestScore });
                    highestScoreDisplay.innerText = `Meilleur score: ${highestScore}`; // Update display for highest score
                }
            } catch (error) {
                console.error("Error saving score:", error);
            }
        }
        
    </script>

</body>
</html>
