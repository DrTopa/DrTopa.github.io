<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bebe Romain Snooze - Game 3</title>
    <style>
        /* Styling setup here is unchanged */
        /* Styling remains as previously defined */
    </style>
</head>
<body>
    <h1>ðŸŽ„ Bebe Romain Snooze - Game 3 ðŸŽ„</h1>

    <div id="userStatus"></div>
    <div id="instructions">
        <p>Hold the button to fill the container! Try to match the target fill percentage. Each round, the shape will change!</p>
    </div>

    <div id="gameArea">
        <button id="start-btn">Start Game</button>
        <button id="fill-btn" disabled>Hold to Fill</button>
        <div id="target-percentage">Target: 0%</div>
        <div id="round-info">Round 1 of 5</div>
        <div id="score">Score: 100</div>
        <div id="totalPlayCountDisplay">Total Plays: 0</div>

        <div id="container">
            <div id="fill"></div>
        </div>

        <!-- Display the fill percentage after each round ends -->
        <div id="roundFillDisplay">Last Round Fill: 0%</div>
    </div>

    <script defer type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = '';
        let totalPlayCountGame3 = 0;
        let highestScoreGame3 = 0;
        let round = 1;
        let score = 100;
        let targetFill = 0;
        let currentFill = 0;
        let fillInterval;

        const startBtn = document.getElementById('start-btn');
        const fillBtn = document.getElementById('fill-btn');
        const targetDisplay = document.getElementById('target-percentage');
        const scoreDisplay = document.getElementById('score');
        const roundInfo = document.getElementById('round-info');
        const fillElement = document.getElementById('fill');
        const totalPlayCountDisplay = document.getElementById('totalPlayCountDisplay');
        const container = document.getElementById('container');
        const roundFillDisplay = document.getElementById('roundFillDisplay'); // New display for last round's fill percentage
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('userStatus').innerText = `Welcome: ${user.email}`;

                const userRef = doc(db, 'users', userId);
                const docSnap = await getDoc(userRef);

                if (!docSnap.exists()) {
                    await setDoc(userRef, { userId: userId, totalPlayCountGame3: 0, highestScoreGame3: 0 });
                } else {
                    const userData = docSnap.data();
                    totalPlayCountGame3 = userData.totalPlayCountGame3 || 0;
                    highestScoreGame3 = userData.highestScoreGame3 || 0;
                    totalPlayCountDisplay.innerText = `Total Plays: ${totalPlayCountGame3}`;
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        startBtn.addEventListener('click', startGame);
        fillBtn.addEventListener('mousedown', startFilling);
        fillBtn.addEventListener('mouseup', stopFilling);

        function startGame() {
            round = 1;
            score = 100;
            totalPlayCountGame3++;
            totalPlayCountDisplay.innerText = `Total Plays: ${totalPlayCountGame3}`;
            updateContainerShape();
            resetFill();
            updateTarget();
            startBtn.disabled = true;
            fillBtn.disabled = false;
            updateFirebasePlayCount();
            roundFillDisplay.innerText = 'Last Round Fill: 0%'; // Reset last round fill display
        }

        async function updateFirebasePlayCount() {
            await updateDoc(doc(db, 'users', userId), { totalPlayCountGame3 });
        }

        function updateTarget() {
            targetFill = Math.floor(Math.random() * 61) + 30;
            targetDisplay.innerText = `Target: ${targetFill}%`;
            roundInfo.innerText = `Round ${round} of 5`;
        }

        function resetFill() {
            currentFill = 0;
            fillElement.style.height = '0%';
        }

        function startFilling() {
            fillInterval = setInterval(() => {
                if (currentFill < 100) {
                    currentFill++;
                    fillElement.style.height = `${currentFill}%`;
                }
            }, 50);
        }

        function stopFilling() {
            clearInterval(fillInterval);
            calculateScore();
        }

        function calculateScore() {
            const difference = Math.abs(currentFill - targetFill);
            const roundPenalty = difference;
            score -= roundPenalty;
            scoreDisplay.innerText = `Score: ${score}`;
            
            // Show last round fill percentage after calculating score
            roundFillDisplay.innerText = `Last Round Fill: ${currentFill}%`;

            if (round < 5) {
                round++;
                resetFill();
                updateContainerShape();
                updateTarget();
            } else {
                fillBtn.disabled = true;
                saveScore(score);
                startBtn.disabled = false;
            }
        }

        function updateContainerShape() {
            switch (round) {
                case 2:
                    container.style.clipPath = 'ellipse(50% 30% at 50% 70%)'; // Bowl shape
                    break;
                case 3:
                    container.style.clipPath = 'path("M50,90 Q100,50 50,10 Q0,50 50,90")'; // Heart shape
                    break;
                case 4:
                    container.style.clipPath = 'polygon(50% 0%, 65% 15%, 70% 100%, 30% 100%, 35% 15%)'; // Vase shape
                    break;
                case 5:
                    container.style.clipPath = 'ellipse(40% 80% at 50% 50%)'; // Moon shape
                    break;
                default:
                    container.style.clipPath = 'polygon(0 0, 100% 0, 100% 100%, 0% 100%)'; // Default shape
                    break;
            }
        }

        async function saveScore(finalScore) {
            try {
                const gameData = { score: finalScore, round: round, timestamp: new Date() };
                await addDoc(collection(db, 'users', userId, 'Game3'), gameData);

                const userRef = doc(db, 'users', userId);
                if (totalPlayCountGame1 <= 3 &&finalScore > highestScoreGame3) {
                    highestScoreGame3 = finalScore;
                    await updateDoc(userRef, { highestScoreGame3 });
                }
            } catch (error) {
                console.error("Error saving score:", error);
            }
        }
    </script>
</body>
</html>

