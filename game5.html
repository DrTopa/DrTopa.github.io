<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bebe Romain Snooze - Jeu 3</title>
    <style>
        /* General body styling */
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            display: flex;
            justify-content: start;
            align-items: center;
            flex-direction: column;
            padding-top: 20px;
            height: 100vh;
            background-color: #ffebcd;
            background-image: url('https://www.transparenttextures.com/patterns/snow.png');
            margin: 0;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #d32f2f;
            font-family: 'Comic Sans MS', cursive;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        }

        #userStatus {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.2em;
            color: #a23636;
        }

        #instructions {
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            text-align: center;
            max-width: 800px;
            font-size: 1.2em;
            color: #333;
        }

        #gameArea {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid #b71c1c;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
        }

        #start-btn, #fill-btn {
            padding: 10px 20px;
            margin: 10px;
            font-size: 1.5em;
            cursor: pointer;
            background-color: #388e3c;
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        #fill-btn:disabled {
            background-color: #757575;
            cursor: not-allowed;
        }

        #target-percentage, #score, #round-info, #totalPlayCountDisplay {
            font-size: 1.8em;
            margin: 15px;
            color: #1565c0;
        }

        #container {
            width: 100px;
            height: 100px;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
            background-color: #eee;
            clip-path: polygon(0 0, 100% 0, 100% 100%, 0% 100%); /* Default square shape */
        }

        #fill {
            background-color: #2196F3;
            width: 100%;
            height: 0%;
            position: absolute;
            bottom: 0;
        }

    </style>
</head>
<body>
    <h1>ðŸŽ„ Remplis la gamelle de RaseToiLaMoustache - Jeu 3 ðŸŽ„</h1>

    <div id="userStatus"></div>
    <div id="instructions">
        <p>Maintenez le bouton pour remplir le rÃ©cipient! Essayez de correspondre au pourcentage de remplissage cible. Chaque manche, la forme change!</p>
    </div>

    <div id="gameArea">
        <button id="start-btn">DÃ©marrer le Jeu</button>
        <button id="fill-btn" disabled>Maintenir pour Remplir</button>
        <div id="target-percentage">Objectif: 0%</div>
        <div id="round-info">Manche 1 sur 5</div>
        <div id="score">Score : 100</div>
        <div id="totalPlayCountDisplay">Total des parties: 0</div>

        <div id="container">
            <div id="fill"></div>
        </div>

        <!-- Affichage du pourcentage de remplissage aprÃ¨s chaque manche -->
        <div id="roundFillDisplay">Remplissage DerniÃ¨re Manche: 0%</div>
    </div>

    <script defer type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC4bjg7lVwd8FU8MREaPhBsBENv5qmiYYM",
            authDomain: "calendrier-de-l-avent-54e3a.firebaseapp.com",
            databaseURL: "https://calendrier-de-l-avent-54e3a-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "calendrier-de-l-avent-54e3a",
            storageBucket: "calendrier-de-l-avent-54e3a.appspot.com",
            messagingSenderId: "850639567855",
            appId: "1:850639567855:web:0d799a1ecca005fcff141a",
            measurementId: "G-PC1W7RYVEH"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = '';
        let totalPlayCountGame3 = 0;
        let highestScoreGame3 = 0;
        let round = 1;
        let score = 100;
        let targetFill = 0;
        let currentFill = 0;
        let fillInterval;
        let shapeType = 'rectangle';

        const startBtn = document.getElementById('start-btn');
        const fillBtn = document.getElementById('fill-btn');
        const targetDisplay = document.getElementById('target-percentage');
        const scoreDisplay = document.getElementById('score');
        const roundInfo = document.getElementById('round-info');
        const fillElement = document.getElementById('fill');
        const totalPlayCountDisplay = document.getElementById('totalPlayCountDisplay');
        const container = document.getElementById('container');
        const roundFillDisplay = document.getElementById('roundFillDisplay'); // New display for last round's fill percentage

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('userStatus').innerText = `Bienvenue: ${user.email}`;

                const userRef = doc(db, 'users', userId);
                const docSnap = await getDoc(userRef);

                if (!docSnap.exists()) {
                    await setDoc(userRef, { userId: userId, totalPlayCountGame3: 0, highestScoreGame3: 0 });
                } else {
                    const userData = docSnap.data();
                    totalPlayCountGame3 = userData.totalPlayCountGame3 || 0;
                    highestScoreGame3 = userData.highestScoreGame3 || 0;
                    totalPlayCountDisplay.innerText = `Total des parties: ${totalPlayCountGame3}`;
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        startBtn.addEventListener('click', startGame);
        fillBtn.addEventListener('mousedown', startFilling);
        fillBtn.addEventListener('mouseup', stopFilling);

        function startGame() {
            round = 1;
            score = 100;
            totalPlayCountGame3++;
            totalPlayCountDisplay.innerText = `Total des parties: ${totalPlayCountGame3}`;
            updateContainerShape();
            resetFill();
            updateTarget();
            startBtn.disabled = true;
            fillBtn.disabled = false;
            updateFirebasePlayCount();
            roundFillDisplay.innerText = 'Remplissage DerniÃ¨re Manche: 0%';
        }

        async function updateFirebasePlayCount() {
            await updateDoc(doc(db, 'users', userId), { totalPlayCountGame3 });
        }

        function updateTarget() {
            targetFill = Math.floor(Math.random() * 61) + 30;
            targetDisplay.innerText = `Objectif: ${targetFill}%`;
            roundInfo.innerText = `Manche ${round} sur 5`;
        }

        function resetFill() {
            currentFill = 0;
            fillElement.style.height = '0%';
        }

        function startFilling() {
            if (!fillInterval) {
                fillInterval = setInterval(() => {
                    currentFill += 1; // Increment by 1% for this example
                    let effectiveFill;

                    if (shapeType === 'rectangle') {
                        effectiveFill = currentFill; // Directly proportional
                    } else if (shapeType === 'triangle') {
                        effectiveFill = Math.sqrt(currentFill / 100) * 100; // Quadratic scaling for triangle
                    } 

                    fillElement.style.height = `${currentFill}%`;

                    if (effectiveFill >= targetFill) {
                        stopFilling();
                    }
                }, 100); // Adjust the interval speed if needed
            }
        }

        function stopFilling() {
            clearInterval(fillInterval);
            fillInterval = null;
            const finalFillPercent = shapeType === 'triangle' ? Math.sqrt(currentFill / 100) * 100 : currentFill;

            checkScore(finalFillPercent);

            if (round < 5) {
                round++;
                updateContainerShape();
                resetFill();
                updateTarget();
            } else {
                endGame();
            }
        }

        function checkScore(finalFillPercent) {
            const difference = Math.abs(finalFillPercent - targetFill);
            score -= difference;
            scoreDisplay.innerText = `Score : ${Math.max(0, score)}`;
            roundFillDisplay.innerText = `Remplissage DerniÃ¨re Manche: ${finalFillPercent.toFixed(1)}%`;
        }

        function endGame() {
            fillBtn.disabled = true;
            startBtn.disabled = false;
            if (score > highestScoreGame3) {
                highestScoreGame3 = score;
                updateHighestScore();
            }
        }

        async function updateHighestScore() {
            await updateDoc(doc(db, 'users', userId), { highestScoreGame3: highestScoreGame3 });
        }

        function updateContainerShape() {
            const shapes = ['rectangle', 'triangle'];
            shapeType = shapes[Math.floor(Math.random() * shapes.length)];

            if (shapeType === 'rectangle') {
                container.style.clipPath = 'polygon(0 0, 100% 0, 100% 100%, 0% 100%)';
            } else if (shapeType === 'triangle') {
                container.style.clipPath = 'polygon(50% 0, 0% 100%, 100% 100%)';
            }
        }
    </script>
</body>
</html>
