<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Remplissez la gamelle de RaseToiLaMoustache - Jeu 3</title>
    <style>
        /* General body styling */
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            display: flex;
            justify-content: start; /* Adjusted to make title more visible */
            align-items: center;
            flex-direction: column;
            background-color: #ffebcd;
            background-image: url('https://www.transparenttextures.com/patterns/snow.png');
            margin: 0;
            padding-top: 20px; /* Add padding to shift content down */
             overflow-y: auto;  /* Added for scrolling if needed */
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px; /* Reduced margin */
            color: #d32f2f;
            font-family: 'Comic Sans MS', cursive;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        #userStatus {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.2em;
            color: #a23636;
        }

        #instructions {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            text-align: center;
            max-width: 1000px;
            font-size: 1.2em;
            color: #333;
            max-height: 500px; /* Set a maximum height */
           overflow-y: auto;  /* Added for scrolling if needed */

        }

        #gameArea {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid #b71c1c;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
        }

        #start-btn, #fill-btn {
            padding: 10px 20px;
            margin: 10px;
            font-size: 1.5em;
            cursor: pointer;
            background-color: #388e3c;
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        #fill-btn:disabled {
            background-color: #757575;
            cursor: not-allowed;
        }

        #target-percentage, #score, #round-info, #totalPlayCountDisplay, #highestScoreDisplay {
            font-size: 1.8em;
            margin: 15px;
            color: #1565c0;
        }

        #container {
            width: 100px;
            height: 100px;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
            background-color: #eee;
            clip-path: polygon(0 0, 100% 0, 100% 100%, 0% 100%); /* Default square shape */
        }

        #fill {
            background-color: #2196F3;
            width: 100%;
            height: 0%;
            position: absolute;
            bottom: 0;
        }

        
    </style>
</head>
<body>
    <h1>🎄 Remplissez la gamelle de RaseToiLaMoustache - Jeu 3 🎄</h1>

    <div id="userStatus"></div>
    <div id="instructions">
        <p>Alors que les bébés Romain prenaient une pause bien méritée, riant et jouant à comparer leur taille de chaussures, Topapa de Noël fit irruption dans l'atelier.« Les nains, il est temps de s’occuper des rênes de Noël ! » annonça-t-il en pointant du doigt les quatre rênes en tee-shirt qui grelotaient dehors enroulés dans 2 plaids : Loris, Artaban, Phasme et RaseToiLaMoustache.</p>
        <p>Les bébés Romain hésitaient à s'occuper des rennes, redoutant leur comportement imprévisible. Ils se souvenaient tous des caprices alimentaires de ces créatures : une fois, après que Topapa ait préparé des pizzas — surnommées affectueusement "Topapizzas" — les rennes avaient refusé de les manger chaudes, préférant les tremper dans la neige pour les refroidir. Lors de la dernière soirée raclette, ils avaient fermé les yeux en plein repas, dégustant le fromage froid, ignorant le rituel de le faire fondre. Le pire moment restait tout de même la fameuse soirée "endives braisées." C'était une tradition que tout le monde attendait avec impatience, car ce plat, doucement caramélisé et fondant, faisait l'unanimité à l’atelier. Mais les rennes, eux, avaient d'autres plans. Ils avaient à peine jeté un coup d’œil aux assiettes fumantes avant de secouer la tête, comme pour dire "non, merci." Puis, sans prévenir, ils s'envolèrent vers le Burgé K1gue du coin. Là-bas, ils commandèrent une salade Caesar et un grand gobelet d’eau à volonté. Pourquoi ? Parce que, selon eux, l’eau était tout simplement la meilleure boisson du monde. Bref, nourrir les rennes n'était jamais de tout repos. </p>
        <p>Pour échapper à la corvée, les lutins inventèrent un jeu simple mais efficace : Celui qui a… L’objectif était de trouver un critère de description ; ceux qui correspondaient étaient sauvés.</p>
        <p>« Celui qui a un pantalon jaune », annonça le premier joueur. Un soupir de soulagement traversa les rangs alors que la majorité des bébés Romain constataient qu’ils étaient concernés. « Celui qui a la même coupe que Justin Bieber », enchaîna un lutin en pantalon bleu ciel éclatant. Mais personne ne réagit, chacun arborant fièrement un style digne de Bruce Willis. </p>
        <p>« Celui qui a des chaussures de sécurité ! » lança alors un autre. Tous les regards se tournèrent vers Bébé Romain, qui, ayant perdu un pari, avait troqué ses chaussures pour des chaussettes imprimées de pizzas. Le verdict était clair : c'était à lui de nourrir les rennes de Noël.</p>

        <p>Bébé Romain se précipita vers le frigo, décidé à rassembler les ingrédients nécessaires pour nourrir les rênes affamées. « Du blanc de poulet et du riz, ça devrait leur plaire, » murmura-t-il en fouillant dans les tiroirs.</p>
        <p>Puis il servit aux rênes la meilleur boisson du monde, une bonne gamelle d’eau fraîche. Mais attention, il avait entendu les instructions de Topapa : «  Les bougs sont très exigeants sur la quantité d’eau ». Avec précaution, il ajusta le niveau de l’eau, un regard concentré sur son travail, comme un scientifique en train de réaliser du bon vieux polyurée.</p>
        <p>Explication du jeu : Vous devez remplir les formes au plus près du pourcentage cible. Le pourcentage s’exprime en volume de la forme. Attention aux volumes plus complexes. Chaque différence entre le pourcentage réel et la cible retire des points à votre score (qui commence à 100). Vous avez 10 essais pour améliorer votre score. Le jeu est encore disponible après mais le meilleur score ne sera pas amélioré.</p> 
        <p>Jeu impossible sur Smartphone
        </p>
    </div>

    <div id="gameArea">
        <button id="start-btn">Commencer le Jeu</button>
        <button id="fill-btn" disabled>Maintenir pour Remplir</button>
        <div id="round-info">Manche 1 sur 5</div>
        <div id="score">Score : 100</div>
        <div id="target-percentage">Cible : 0%</div>
        <div id="highestScoreDisplay">Meilleur Score : 0</div>
        <div id="totalPlayCountDisplay">Total des Parties : 0</div>

        <div id="container">
            <div id="fill"></div>
        </div>

        <!-- Display the fill percentage after each round ends -->
        <div id="roundFillDisplay">Remplissage Dernière Manche : 0%</div>
    </div>

    <script defer type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC4bjg7lVwd8FU8MREaPhBsBENv5qmiYYM",
            authDomain: "calendrier-de-l-avent-54e3a.firebaseapp.com",
            databaseURL: "https://calendrier-de-l-avent-54e3a-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "calendrier-de-l-avent-54e3a",
            storageBucket: "calendrier-de-l-avent-54e3a.appspot.com",
            messagingSenderId: "850639567855",
            appId: "1:850639567855:web:0d799a1ecca005fcff141a",
            measurementId: "G-PC1W7RYVEH"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = '';
        let totalPlayCountGame3 = 0;
        let highestScoreGame3 = 0;
        let round = 1;
        let score = 100;
        let targetFill = 0;
        let currentFill = 0;
        let fillInterval;

        const startBtn = document.getElementById('start-btn');
        const fillBtn = document.getElementById('fill-btn');
        const targetDisplay = document.getElementById('target-percentage');
        const scoreDisplay = document.getElementById('score');
        const roundInfo = document.getElementById('round-info');
        const fillElement = document.getElementById('fill');
        const totalPlayCountDisplay = document.getElementById('totalPlayCountDisplay');
        const container = document.getElementById('container');
        const roundFillDisplay = document.getElementById('roundFillDisplay');
        const highestScoreDisplay = document.getElementById('highestScoreDisplay');
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('userStatus').innerText = `Bienvenue : ${user.email}`;

                const userRef = doc(db, 'users', userId);
                const docSnap = await getDoc(userRef);

                if (!docSnap.exists()) {
                    await setDoc(userRef, { userId: userId, totalPlayCountGame3: 0, highestScoreGame3: 0 });
                } else {
                    const userData = docSnap.data();
                    totalPlayCountGame3 = userData.totalPlayCountGame3 || 0;
                    highestScoreGame3 = userData.highestScoreGame3 || 0;
                    totalPlayCountDisplay.innerText = `Total des Parties : ${totalPlayCountGame3}`;
                    document.getElementById('highestScoreDisplay').innerText = `Meilleur Score : ${highestScoreGame3}`; // Add this line
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        startBtn.addEventListener('click', startGame);
        fillBtn.addEventListener('mousedown', startFilling);
        fillBtn.addEventListener('mouseup', stopFilling);

        function startGame() {
            round = 1;
            score = 100;
            totalPlayCountGame3++;
            totalPlayCountDisplay.innerText = `Total des Parties : ${totalPlayCountGame3}`;
            document.getElementById('highestScoreDisplay').innerText = `Meilleur Score : ${highestScoreGame3}`; // Update display
            updateContainerShape();
            resetFill();
            updateContainerShape();
            resetFill();
            updateTarget();
            startBtn.disabled = true;
            fillBtn.disabled = false;
            updateFirebasePlayCount();
            roundFillDisplay.innerText = 'Remplissage Dernière Manche : 0%';
        }

        async function updateFirebasePlayCount() {
            await updateDoc(doc(db, 'users', userId), { totalPlayCountGame3 });
        }

        function updateTarget() {
            targetFill = Math.floor(Math.random() * 61) + 30;
            targetDisplay.innerText = `Cible : ${targetFill}%`;
            roundInfo.innerText = `Manche ${round} sur 5`;
        }

        function resetFill() {
            currentFill = 0;
            fillElement.style.height = '0%';
        }

        function startFilling() {
            fillInterval = setInterval(() => {
                if (currentFill < 100) {
                    currentFill++;
                    fillElement.style.height = `${currentFill}%`;
                }
            }, 50);
        }

        function stopFilling() {
            clearInterval(fillInterval);
            calculateScore();
        }

        function calculateScore() {
             let fillPercentage;

            // Use calculateFillPercentage only for triangle rounds
            if (round >= 2 && round <= 5) {
                fillPercentage = Math.round(calculateFillPercentage(currentFill)); // Calculate fill percentage for triangle
            } else {
                fillPercentage = Math.round(currentFill); // Use current fill directly for non-triangle shapes
            }
            
            const difference = Math.abs(fillPercentage - targetFill);
            const roundPenalty = difference;
            score -= roundPenalty;
            scoreDisplay.innerText = `Score : ${score}`;
            
            // Display both the fill percentage and target, along with the score for the previous round
            roundFillDisplay.innerText = `Remplissage Dernière Manche : ${fillPercentage}% (Cible : ${targetFill}%) - Score pour cette manche : ${score}`;


            if (round < 5) {
                round++;
                resetFill();
                updateContainerShape();
                updateTarget();
            } else {
                fillBtn.disabled = true;
                saveScore(score);
                startBtn.disabled = false;
            }
        }

function updateContainerShape() {
    switch (round) {
        case 2:
            container.style.clipPath = 'polygon(0% 100%, 100% 100%, 50% 0%)'; // Triangle 1
            break;
        case 3:
            container.style.clipPath = 'polygon(0% 100%, 80% 100%, 15% 0%)'; // Triangle 2
            break;
        case 4:
            container.style.clipPath = 'polygon(50% 100%, 10% 0%, 60% 0%)'; // Triangle 3
            break;
        case 5:
            container.style.clipPath = 'polygon(20% 100%, 20% 0%, 70% 0%)'; // Triangle 4
            break;
        default:
            container.style.clipPath = 'polygon(0 0, 100% 0, 100% 100%, 0% 100%)'; // Default shape
            break;
    }
}

function calculateFillPercentage(fillHeight) {
    let base, height;
    switch (round) {
        case 2: // Triangle 1
            base = 100; // Base of triangle
            height = 100; // Height of triangle
            break;
        case 3: // Triangle 2
            base = 80; // Base of triangle
            height = 100; // Height of triangle
            break;
        case 4: // Triangle 3
            base = 50; // Base of triangle
            height = 100; // Height of triangle
            break;
        case 5: // Triangle 4
            base = 50; // Base of triangle
            height = 100; // Height of triangle
            break;
        default:
            return 0; // In case of the first round (square)
    }

    const totalArea = (base * height) / 2; // Area of the triangle
    const unfilledHeight = height-fillHeight
    const ratio = unfilledHeight/ height; // 
    let fillPercentage;
    let unfilledArea;
    if (round >= 2 && round <= 3) {
        unfilledArea = ((base*ratio) * (height*ratio)) / 2; // Area of the unfilled part
        fillPercentage = (1-(unfilledArea / totalArea)) * 100; // Calculate the fill percentage
    } else {
        unfilledArea = ((base*(1-ratio)) * (fillHeight)) / 2; // Area of the unfilled part
        fillPercentage = ((unfilledArea / totalArea)) * 100; // Calculate the fill percentage
    }
        // Log values to the console
    console.log("Total Area:", totalArea);
    console.log("Ratio (fillHeight/height):", ratio);
    console.log("Unfilled Area:", unfilledArea);
    console.log("Fill Percentage:", fillPercentage);
    return fillPercentage; // Return the filling percentage
}

        async function saveScore(finalScore) {
            try {
                const gameData = { score: finalScore, round: round, timestamp: new Date() };
                await addDoc(collection(db, 'users', userId, 'Game3'), gameData);

                const userRef = doc(db, 'users', userId);
                if (totalPlayCountGame3 <= 10 && finalScore > highestScoreGame3) {
                    highestScoreGame3 = finalScore;
                    await updateDoc(userRef, { highestScoreGame3 : finalScore});
                    document.getElementById('highestScoreDisplay').innerText = `Meilleur Score : ${highestScoreGame3}`; // Update display
                }
            } catch (error) {
                console.error("Erreur lors de la sauvegarde du score :", error);
            }
        }
    </script>
</body>
</html>
