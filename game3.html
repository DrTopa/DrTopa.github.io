<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Remplissez la gamelle de RaseToiLaMoustache - Jeu 3</title>
    <style>
        /* General body styling */
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            display: flex;
            justify-content: start; /* Adjusted to make title more visible */
            align-items: center;
            flex-direction: column;
            background-color: #ffebcd;
            background-image: url('https://www.transparenttextures.com/patterns/snow.png');
            margin: 0;
            padding-top: 20px; /* Add padding to shift content down */
             overflow-y: auto;  /* Added for scrolling if needed */
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px; /* Reduced margin */
            color: #d32f2f;
            font-family: 'Comic Sans MS', cursive;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        #userStatus {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.2em;
            color: #a23636;
        }

        #instructions {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            text-align: center;
            max-width: 1000px;
            font-size: 1.2em;
            color: #333;
            max-height: 500px; /* Set a maximum height */
           overflow-y: auto;  /* Added for scrolling if needed */

        }

        #gameArea {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid #b71c1c;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
        }

        #start-btn, #fill-btn {
            padding: 10px 20px;
            margin: 10px;
            font-size: 1.5em;
            cursor: pointer;
            background-color: #388e3c;
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        #fill-btn:disabled {
            background-color: #757575;
            cursor: not-allowed;
        }

        #target-percentage, #score, #round-info, #totalPlayCountDisplay {
            font-size: 1.8em;
            margin: 15px;
            color: #1565c0;
        }

        #container {
            width: 100px;
            height: 100px;
            margin-top: 20px;
            position: relative;
            overflow: hidden;
            background-color: #eee;
            clip-path: polygon(0 0, 100% 0, 100% 100%, 0% 100%); /* Default square shape */
        }

        #fill {
            background-color: #2196F3;
            width: 100%;
            height: 0%;
            position: absolute;
            bottom: 0;
        }

                /* Christmas Lights Effect */
        #christmas-lights {
            position: fixed;
            top: 30%;
            left: 30%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            overflow: hidden;
            z-index: 999;
        }

        .light {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            animation: twinkle 1.5s infinite alternate;
        }

/* Left Side Lights */
.light:nth-child(1) { left: -50px; top: -20px; background-color: #ff0000; animation-delay: 0.2s; }
.light:nth-child(2) { left: -50px; top: 20px; background-color: #00ff00; animation-delay: 0.4s; }
.light:nth-child(3) { left: -50px; top: 60px; background-color: #0000ff; animation-delay: 0.6s; }
.light:nth-child(4) { left: -50px; top: 100px; background-color: #ffff00; animation-delay: 0.8s; }

/* Right Side Lights */
.light:nth-child(5) { left: 50px; top: -20px; background-color: #ff00ff; animation-delay: 1s; }
.light:nth-child(6) { left: 50px; top: 20px; background-color: #ff9900; animation-delay: 1.2s; }
.light:nth-child(7) { left: 50px; top: 60px; background-color: #00ffff; animation-delay: 1.4s; }
.light:nth-child(8) { left: 50px; top: 100px; background-color: #ff6699; animation-delay: 1.6s; }


        @keyframes twinkle {
            0% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }
        
    </style>
</head>
<body>
    <h1>üéÑ Remplissez la gamelle de RaseToiLaMoustache - Jeu 3 üéÑ</h1>

    <div id="userStatus"></div>
    <div id="instructions">
        <p>Alors que les b√©b√©s Romain prenaient une pause bien m√©rit√©e, riant et jouant √† comparer leur taille de chaussures, Topapa de No√´l fit irruption dans l'atelier.¬´ Les nains, il est temps de s‚Äôoccuper des r√™nes de No√´l ! ¬ª annon√ßa-t-il en pointant du doigt les quatre r√™nes en tee-shirt qui grelotaient dehors enroul√©s dans 2 plaids : Loris, Artaban, Phasme et RaseToiLaMoustache.</p>
        <p>Les b√©b√©s Romain h√©sitaient √† s'occuper des rennes, redoutant leur comportement impr√©visible. Ils se souvenaient tous des caprices alimentaires de ces cr√©atures : une fois, apr√®s que Topapa ait pr√©par√© des pizzas ‚Äî surnomm√©es affectueusement "Topapizzas" ‚Äî les rennes avaient refus√© de les manger chaudes, pr√©f√©rant les tremper dans la neige pour les refroidir. Lors de la derni√®re soir√©e raclette, ils avaient ferm√© les yeux en plein repas, d√©gustant le fromage froid, ignorant le rituel de le faire fondre. Le pire moment restait tout de m√™me la fameuse soir√©e "endives brais√©es." C'√©tait une tradition que tout le monde attendait avec impatience, car ce plat, doucement caram√©lis√© et fondant, faisait l'unanimit√© √† l‚Äôatelier. Mais les rennes, eux, avaient d'autres plans. Ils avaient √† peine jet√© un coup d‚Äô≈ìil aux assiettes fumantes avant de secouer la t√™te, comme pour dire "non, merci." Puis, sans pr√©venir, ils s'envol√®rent vers le Burg√© K1gue du coin. L√†-bas, ils command√®rent une salade Caesar et un grand gobelet d‚Äôeau √† volont√©. Pourquoi ? Parce que, selon eux, l‚Äôeau √©tait tout simplement la meilleure boisson du monde. Bref, nourrir les rennes n'√©tait jamais de tout repos. </p>
        <p>Pour √©chapper √† la corv√©e, les lutins invent√®rent un jeu simple mais efficace : Celui qui a‚Ä¶ L‚Äôobjectif √©tait de trouver un crit√®re de description ; ceux qui correspondaient √©taient sauv√©s.</p>
        <p>¬´ Celui qui a un pantalon jaune ¬ª, annon√ßa le premier joueur. Un soupir de soulagement traversa les rangs alors que la majorit√© des b√©b√©s Romain constataient qu‚Äôils √©taient concern√©s. ¬´ Celui qui a la m√™me coupe que Justin Bieber ¬ª, encha√Æna un lutin en pantalon bleu ciel √©clatant. Mais personne ne r√©agit, chacun arborant fi√®rement un style digne de Bruce Willis. </p>
        <p>¬´ Celui qui a des chaussures de s√©curit√© ! ¬ª lan√ßa alors un autre. Tous les regards se tourn√®rent vers B√©b√© Romain, qui, ayant perdu un pari, avait troqu√© ses chaussures pour des chaussettes imprim√©es de pizzas. Le verdict √©tait clair : c'√©tait √† lui de nourrir les rennes de No√´l.</p>

        <p>B√©b√© Romain se pr√©cipita vers le frigo, d√©cid√© √† rassembler les ingr√©dients n√©cessaires pour nourrir les r√™nes affam√©es. ¬´ Du blanc de poulet et du riz, √ßa devrait leur plaire, ¬ª murmura-t-il en fouillant dans les tiroirs.</p>
        <p>Puis il servit aux r√™nes la meilleur boisson du monde, une bonne gamelle d‚Äôeau fra√Æche. Mais attention, il avait entendu les instructions de Topapa : ¬´  Les bougs sont tr√®s exigeants sur la quantit√© d‚Äôeau ¬ª. Avec pr√©caution, il ajusta le niveau de l‚Äôeau, un regard concentr√© sur son travail, comme un scientifique en train de r√©aliser du bon vieux polyur√©e.</p>
        <p>Explication du jeu : Vous devez remplir les formes au plus pr√®s du pourcentage cible. Le pourcentage s‚Äôexprime en volume de la forme. Attention aux volumes plus complexes. Chaque diff√©rence entre le pourcentage r√©el et la cible retire des points √† votre score (qui commence √† 100). Vous avez 10 essais pour am√©liorer votre score. Le jeu est encore disponible apr√®s mais le meilleur score ne sera pas am√©lior√©.</p> 
        <p>Jeu impossible sur Smartphone
        </p>
    </div>
    <div id="christmas-lights">
        <div class="light"></div>
        <div class="light"></div>
        <div class="light"></div>
        <div class="light"></div>
        <div class="light"></div>
        <div class="light"></div>
        <div class="light"></div>
        <div class="light"></div>
    </div>
    <div id="gameArea">
        <button id="start-btn">Commencer le Jeu</button>
        <button id="fill-btn" disabled>Maintenir pour Remplir</button>
        <div id="target-percentage">Cible : 0%</div>
        <div id="round-info">Manche 1 sur 5</div>
        <div id="score">Score : 100</div>
        <div id="highestScoreDisplay">Meilleur Score : 0</div>
        <div id="totalPlayCountDisplay">Total des Parties : 0</div>

        <div id="container">
            <div id="fill"></div>
        </div>

        <!-- Display the fill percentage after each round ends -->
        <div id="roundFillDisplay">Remplissage Derni√®re Manche : 0%</div>
    </div>

    <script defer type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC4bjg7lVwd8FU8MREaPhBsBENv5qmiYYM",
            authDomain: "calendrier-de-l-avent-54e3a.firebaseapp.com",
            databaseURL: "https://calendrier-de-l-avent-54e3a-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "calendrier-de-l-avent-54e3a",
            storageBucket: "calendrier-de-l-avent-54e3a.appspot.com",
            messagingSenderId: "850639567855",
            appId: "1:850639567855:web:0d799a1ecca005fcff141a",
            measurementId: "G-PC1W7RYVEH"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = '';
        let totalPlayCountGame3 = 0;
        let highestScoreGame3 = 0;
        let round = 1;
        let score = 100;
        let targetFill = 0;
        let currentFill = 0;
        let fillInterval;

        const startBtn = document.getElementById('start-btn');
        const fillBtn = document.getElementById('fill-btn');
        const targetDisplay = document.getElementById('target-percentage');
        const scoreDisplay = document.getElementById('score');
        const roundInfo = document.getElementById('round-info');
        const fillElement = document.getElementById('fill');
        const totalPlayCountDisplay = document.getElementById('totalPlayCountDisplay');
        const container = document.getElementById('container');
        const roundFillDisplay = document.getElementById('roundFillDisplay');
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('userStatus').innerText = `Bienvenue : ${user.email}`;

                const userRef = doc(db, 'users', userId);
                const docSnap = await getDoc(userRef);

                if (!docSnap.exists()) {
                    await setDoc(userRef, { userId: userId, totalPlayCountGame3: 0, highestScoreGame3: 0 });
                } else {
                    const userData = docSnap.data();
                    totalPlayCountGame3 = userData.totalPlayCountGame3 || 0;
                    highestScoreGame3 = userData.highestScoreGame3 || 0;
                    totalPlayCountDisplay.innerText = `Total des Parties : ${totalPlayCountGame3}`;
                    document.getElementById('highestScoreDisplay').innerText = `Meilleur Score : ${highestScoreGame3}`; // Add this line
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        startBtn.addEventListener('click', startGame);
        fillBtn.addEventListener('mousedown', startFilling);
        fillBtn.addEventListener('mouseup', stopFilling);

        function startGame() {
            round = 1;
            score = 100;
            totalPlayCountGame3++;
            totalPlayCountDisplay.innerText = `Total des Parties : ${totalPlayCountGame3}`;
            document.getElementById('highestScoreDisplay').innerText = `Meilleur Score : ${highestScoreGame3}`; // Update display
            updateContainerShape();
            resetFill();
            updateContainerShape();
            resetFill();
            updateTarget();
            startBtn.disabled = true;
            fillBtn.disabled = false;
            updateFirebasePlayCount();
            roundFillDisplay.innerText = 'Remplissage Derni√®re Manche : 0%';
        }

        async function updateFirebasePlayCount() {
            await updateDoc(doc(db, 'users', userId), { totalPlayCountGame3 });
        }

        function updateTarget() {
            targetFill = Math.floor(Math.random() * 61) + 30;
            targetDisplay.innerText = `Cible : ${targetFill}%`;
            roundInfo.innerText = `Manche ${round} sur 5`;
        }

        function resetFill() {
            currentFill = 0;
            fillElement.style.height = '0%';
        }

        function startFilling() {
            fillInterval = setInterval(() => {
                if (currentFill < 100) {
                    currentFill++;
                    fillElement.style.height = `${currentFill}%`;
                }
            }, 50);
        }

        function stopFilling() {
            clearInterval(fillInterval);
            calculateScore();
        }

        function calculateScore() {
             let fillPercentage;

            // Use calculateFillPercentage only for triangle rounds
            if (round >= 2 && round <= 5) {
                fillPercentage = Math.round(calculateFillPercentage(currentFill)); // Calculate fill percentage for triangle
            } else {
                fillPercentage = Math.round(currentFill); // Use current fill directly for non-triangle shapes
            }
            
            const difference = Math.abs(fillPercentage - targetFill);
            const roundPenalty = difference;
            score -= roundPenalty;
            scoreDisplay.innerText = `Score : ${score}`;
            
            roundFillDisplay.innerText = `Remplissage Derni√®re Manche : ${fillPercentage}%`;

            if (round < 5) {
                round++;
                resetFill();
                updateContainerShape();
                updateTarget();
            } else {
                fillBtn.disabled = true;
                saveScore(score);
                startBtn.disabled = false;
            }
        }

function updateContainerShape() {
    switch (round) {
        case 2:
            container.style.clipPath = 'polygon(0% 100%, 100% 100%, 50% 0%)'; // Triangle 1
            break;
        case 3:
            container.style.clipPath = 'polygon(0% 100%, 80% 100%, 15% 0%)'; // Triangle 2
            break;
        case 4:
            container.style.clipPath = 'polygon(50% 100%, 10% 0%, 60% 0%)'; // Triangle 3
            break;
        case 5:
            container.style.clipPath = 'polygon(20% 100%, 20% 0%, 70% 0%)'; // Triangle 4
            break;
        default:
            container.style.clipPath = 'polygon(0 0, 100% 0, 100% 100%, 0% 100%)'; // Default shape
            break;
    }
}

function calculateFillPercentage(fillHeight) {
    let base, height;
    switch (round) {
        case 2: // Triangle 1
            base = 100; // Base of triangle
            height = 100; // Height of triangle
            break;
        case 3: // Triangle 2
            base = 80; // Base of triangle
            height = 100; // Height of triangle
            break;
        case 4: // Triangle 3
            base = 50; // Base of triangle
            height = 100; // Height of triangle
            break;
        case 5: // Triangle 4
            base = 50; // Base of triangle
            height = 100; // Height of triangle
            break;
        default:
            return 0; // In case of the first round (square)
    }

    const totalArea = (base * height) / 2; // Area of the triangle
    const unfilledHeight = height-fillHeight
    const ratio = unfilledHeight/ height; // 
    let fillPercentage;
    let unfilledArea;
    if (round >= 2 && round <= 3) {
        unfilledArea = ((base*ratio) * (height*ratio)) / 2; // Area of the unfilled part
        fillPercentage = (1-(unfilledArea / totalArea)) * 100; // Calculate the fill percentage
    } else {
        unfilledArea = ((base*(1-ratio)) * (fillHeight)) / 2; // Area of the unfilled part
        fillPercentage = ((unfilledArea / totalArea)) * 100; // Calculate the fill percentage
    }
        // Log values to the console
    console.log("Total Area:", totalArea);
    console.log("Ratio (fillHeight/height):", ratio);
    console.log("Unfilled Area:", unfilledArea);
    console.log("Fill Percentage:", fillPercentage);
    return fillPercentage; // Return the filling percentage
}

        async function saveScore(finalScore) {
            try {
                const gameData = { score: finalScore, round: round, timestamp: new Date() };
                await addDoc(collection(db, 'users', userId, 'Game3'), gameData);

                const userRef = doc(db, 'users', userId);
                if (totalPlayCountGame3 <= 10 && finalScore > highestScoreGame3) {
                    highestScoreGame3 = finalScore;
                    await updateDoc(userRef, { highestScoreGame3 : finalScore});
                    document.getElementById('highestScoreDisplay').innerText = `Meilleur Score : ${highestScoreGame3}`; // Update display
                }
            } catch (error) {
                console.error("Erreur lors de la sauvegarde du score :", error);
            }
        }
    </script>
</body>
</html>
