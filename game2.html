<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game 2 - Quiz Challenge</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            height: 100vh;
            background-color: #f0f0f0;
            margin: 0;
        }
        h1 {
            font-size: 2em;
            margin-bottom: 20px;
        }
        #userStatus {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.2em;
        }
        #gameArea {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 50px;
        }
        #start-btn {
            padding: 10px 20px;
            margin: 10px;
            font-size: 1.5em;
            cursor: pointer;
            background-color: #007BFF;
            color: white;
            border: none;
        }
        #start-btn:hover {
            background-color: #0056b3;
        }
        #question {
            font-size: 1.5em;
            margin: 20px;
        }
        #options {
            font-size: 1.2em;
            margin: 10px;
        }
        #timer, #score {
            font-size: 1.5em;
            margin: 10px;
        }
        #input {
            padding: 10px;
            font-size: 1.2em;
            margin: 10px;
            width: 50px;
        }
    </style>
</head>
<body>

    <h1>Quiz Challenge - Game 2</h1>
    <div id="userStatus"></div>

    <div id="gameArea">
        <button id="start-btn">Start Game</button>
        <div id="timer"></div>
        <div id="score"></div>
        <div id="question"></div>
        <div id="options"></div>
        <input type="text" id="input" placeholder="A/B/C/D" maxlength="1" disabled>
    </div>

    <script defer type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC4bjg7lVwd8FU8MREaPhBsBENv5qmiYYM",
            authDomain: "calendrier-de-l-avent-54e3a.firebaseapp.com",
            databaseURL: "https://calendrier-de-l-avent-54e3a-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "calendrier-de-l-avent-54e3a",
            storageBucket: "calendrier-de-l-avent-54e3a.appspot.com",
            messagingSenderId: "850639567855",
            appId: "1:850639567855:web:0d799a1ecca005fcff141a",
          

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = '';
        let score = 0;
        let playCount = 0;
        let totalPlayCountGame2 = 0;  // Renamed variable
        let highestScoreGame2 = 0;     // Renamed variable

        const startBtn = document.getElementById('start-btn');
        const timerDisplay = document.getElementById('timer');
        const scoreDisplay = document.getElementById('score');
        const questionDisplay = document.getElementById('question');
        const optionsDisplay = document.getElementById('options');
        const inputField = document.getElementById('input');

        const questions = [
            {
                question: "8 * 7 equals = ?",
                options: ["A) 54", "B) 45", "C) 56", "D) 87"],
                answer: "C"
            },
            {
                question: "Si je multiplie deux nombres pairs alors j'obtiens un nombre ..",
                options: ["A) Pair", "B) Impair", "C) Quoicoubeix"],
                answer: "A"
            }
        ];

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('userStatus').innerText = `Logged in as: ${user.email}`;

                const userRef = doc(db, 'users', userId);
                const docSnap = await getDoc(userRef);

                if (!docSnap.exists()) {
                    await setDoc(userRef, { userId: userId, totalPlayCountGame2: 0, highestScoreGame2: 0 }); // Initial values
                    console.log("User document created with initial values.");
                } else {
                    const userData = docSnap.data();
                    totalPlayCountGame2 = userData.totalPlayCountGame2 || 0; // Updated to fetch the new total play count
                    highestScoreGame2 = userData.highestScoreGame2 || 0;     // Updated to fetch the new highest score
                    playCount = totalPlayCountGame2 + 1;                     // Increment play count
                    console.log(`Loaded totalPlayCountGame2: ${totalPlayCountGame2}, highestScoreGame2: ${highestScoreGame2}`);
                }
            } else {
                window.location.href = 'login.html';
            }
        });

        startBtn.addEventListener('click', async () => {
            score = 0;
            scoreDisplay.innerText = `Current Score: ${score}`;
            inputField.value = '';
            inputField.disabled = false;
            timerDisplay.innerText = '';
            optionsDisplay.innerHTML = '';

            // Increment totalPlayCountGame2 and update Firestore
            totalPlayCountGame2 += 1;
            await updateDoc(doc(db, 'users', userId), { totalPlayCountGame2: totalPlayCountGame2 });

            let questionIndex = 0;
            showQuestion(questionIndex);

            const timerDuration = 15;
            let timeLeft;

            function startTimer() {
                timeLeft = timerDuration;
                timerDisplay.innerText = `Time Left: ${timeLeft}s`;

                const timer = setInterval(() => {
                    timeLeft -= 1;
                    timerDisplay.innerText = `Time Left: ${timeLeft}s`;

                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        inputField.disabled = true; // Disable input after time runs out
                        checkAnswer(questionIndex, ''); // Check answer as incorrect if time is up
                        questionIndex++;
                        if (questionIndex < questions.length) {
                            showQuestion(questionIndex);
                        } else {
                            endGame();
                        }
                    }
                }, 1000);
                return timer; // Return timer reference for clearing if needed
            }

            let timer = startTimer(); // Start the timer for the first question

            inputField.addEventListener('keyup', (event) => {
                if (event.key === 'Enter' && inputField.value) {
                    clearInterval(timer); // Clear the current timer
                    checkAnswer(questionIndex, inputField.value.toUpperCase());
                    questionIndex++;
                    inputField.value = '';

                    if (questionIndex < questions.length) {
                        showQuestion(questionIndex);
                        timer = startTimer(); // Start the timer for the next question
                    } else {
                        endGame();
                    }
                }
            });
        });

        function showQuestion(index) {
            const question = questions[index];
            questionDisplay.innerText = question.question;
            optionsDisplay.innerHTML = question.options.join('<br>');
            timerDisplay.innerText = `Time Left: 15s`;
            inputField.disabled = false;
            inputField.focus();
        }

        function checkAnswer(index, userAnswer) {
            if (userAnswer === questions[index].answer) {
                score += 5;
                scoreDisplay.innerText = `Current Score: ${score}`;
                console.log("Correct Answer!");
            } else if (userAnswer !== '') {
                console.log("Incorrect Answer.");
            }
        }

        async function saveScore(score) {
            try {
                const gameData = { score: score, playCount: playCount, timestamp: new Date() };
                await addDoc(collection(db, 'users', userId, 'Game2'), gameData);

                const userRef = doc(db, 'users', userId);
                if (score > highestScoreGame2) {  // Updated variable name
                    highestScoreGame2 = score;
                    await updateDoc(userRef, { highestScoreGame2: highestScoreGame2 });
                }
                console.log("Score saved successfully.");
            } catch (error) {
                console.error("Error saving score:", error);
            }
        }

        async function endGame() {
            inputField.disabled = true;
            await saveScore(score); // Save the score at the end of the game
            console.log("Game Over. Final Score:", score);
            alert(`The quiz is over! Your final score is: ${score}`);
        }
    </script>
</body>
</html>

